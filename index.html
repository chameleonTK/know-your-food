<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Which diet is right for me? :: CS5044 Information Visualisation</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="base.css" media="screen" rel="stylesheet" type="text/css">
    <link href="custom.css" media="screen" rel="stylesheet" type="text/css">

    
</head>

<body>
    <!-- svg pattern definitions -->
    <svg width="0" height="0">
        <defs>
            <!-- diagonal hatch from http://stackoverflow.com/questions/13069446/simple-fill-pattern-in-svg-diagonal-hatching -->
            <pattern id="diagonalHatch" patternUnits="userSpaceOnUse" width="4" height="4">
                <path d="M-1,1 l2,-2 M0,4 l4,-4 M3,5 l2,-2" />
            </pattern>
        </defs>
    </svg>

    <!-- <div id="header" class="">
        <div class="container">
            <h1>WHICH DIET IS RIGHT FOR ME?</h1>
        </div>
    </div> -->
    <!-- /header -->

    <div class="container" id= "header" style="margin:8px auto">
        <div id="top-left">
            <img id="diet_img" src="pic/diet_blue.png" alt="diet">
        </div>
        <div id="top-right">
            <h1 id="title" style="margin-bottom: 10px;">WHICH DIET IS RIGHT FOR ME?</h1>
            <p id="introduction">
                Lorem ipsum dolor sit amet, ut nam quis illud, ne modus dolore abhorreant eam, elitr exerci adversarium his ea. Nec nusquam deserunt ne, aliquip voluptatum interesset duo eu, id enim animal has. Eu vim habemus officiis, ad pro vero habeo. Sonet soluta voluptaria vis te.
            </p>
        </div>
        
    </div>
    <div class="container personal-info" style="margin-bottom:30px">
        <div style="float: left;margin-right: 70px;">
            <h1 style="margin-bottom: 20px;">Your Age</h1>
            <div>
                <!-- <button>Baby</button> -->
                <button class="btn-age active" id="btn-teenager">Teenager</button>
                <button class="btn-age" id="btn-elder">Elder</button>
            </div>
        </div>
        <div style="float: left;">
            <h1 style="margin-bottom: 20px;">Your Gender</h1>
            <div>
                <!-- <button>Baby</button> -->
                <button class="btn-sex active" id="btn-male">Male</button>
                <button class="btn-sex" id="btn-female">Female</button>
            </div>
        </div>
        <div style="clear:both"></div>
    </div>

    <div class = "card" style="margin:8px auto">
        <div class="container" style="margin-bottom:30px">
        <h1 class="subtitle">Know your food</h1>
        <hr>

        <div class="filter-area">
            <!-- Nutrients box -->
            <div class="chartCategory nutrients">
                <h2>Nutrients</h2>

                <div class="chartContainer">

                    <h3 class="dimension ">Protein</h3>

                    <div id="chart-protein" class="chart small"></div>
                </div>

                <div class="chartContainer">

                    <h3 class="dimension ">Carbohydrates</h3>

                    <div id="chart-carbohydrate" class="chart small"></div>
                </div>

                <div class="chartContainer">

                    <h3 class="dimension ">Fat</h3>

                    <div id="chart-fat" class="chart small"></div>
                </div>

                <div class="chartContainer">

                    <h3 class="dimension ">Fiber</h3>

                    <div id="chart-fiber" class="chart small"></div>
                </div>
            </div>

            <div class="chartCategory supplementary">
                <h2>Supplementary</h2>

                <div class="chartContainer">

                    <h3 class="dimension ">Minerals</h3>

                    <div id="chart-mineralas" class="chart small"></div>
                </div>

                <div class="chartContainer">

                    <h3 class="dimension ">Vitamins</h3>

                    <div id="chart-vitamins" class="chart small"></div>
                </div>
            </div>

            <div class="chartCategory allergic">
                <h2>Allergic</h2>

                <div class="chartContainer">
                    <h3 class="dimension ">What I cannot eat</h3>
                    <div id="chart-allergic" class="chart small"></div>
                </div>
            </div>

            <div class="chartCategory preference">
                <h2>Preference</h2>

                <div class="chartContainer">
                    <h3 class="dimension ">What I like</h3>
                    <div id="chart-preference" class="chart small"></div>
                </div>
            </div>
            <div style="clear:both"></div>
        </div>
    </div>

    <div class="container" style="margin-bottom:30px">
        <h1 id="graph-title"><b id="no-filtered">259</b> of <span id="no-all">1000</span> dishes</h1>
        <div class="dist-area">
            <div class="chartContainer" id="graph-left">
                <div id="chart-food-cluster" class="chart small"></div>
            </div>
            <div class="search-area" id="graph-right">
                <div class="search-box">
                    <div id="search-bar">
                        <input id="search-bar-input" type="text" placeholder="  Find your favorite">
                    </div>
                    <ul id="food-list"></ul>
                    
                </div>
            </div>
            <div style="clear:both"></div>
        </div>
    </div>   
    </div>

    

    <div class="container card" style="margin-bottom:30px" id="design-area">
        <h1 class="subtitle">Design your diet </h1>
        <hr>
        <div class="detail-area" style="margin-top:15px">
            <div class="chartContainer" style="float: left;">
                <div id="chart-calories" class="chart small"></div>
                <div id="chart-proportion" class="chart small"></div>
            </div>
            <div class="chartContainer" style="float: left;padding-top: 20px;padding-left: 50px;">
                <div id="food-tag-list" class="chart small" style="width: 900px;">
                    <ul></ul>
                </div>
                <div id="chart-nutrients-detail" class="chart small">

                </div>
            </div>
            <div style="clear:both"></div>
        </div>
    </div>

    <!-- imports -->
    <script src="//code.jquery.com/jquery-1.9.1.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.9.2/d3.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.11/lodash.min.js"></script>
    <script type="text/javascript" src="pubsub.js"></script>
    <script type="text/javascript" src="App.js"></script>
    <script type="text/javascript" src="FilterApp.js"></script>
    <script type="text/javascript" src="AreaChart.js"></script>
    <script type="text/javascript" src="BubbleChart.js"></script>
    <script type="text/javascript" src="RadarChart.js"></script>

    <script type="text/javascript" src="PieChart.js"></script>
    <script type="text/javascript" src="TernaryPlot.js"></script>
    <script type="text/javascript" src="ScaleChart.js"></script>

    <script type="text/javascript" src="ExplorerApp.js"></script>
    <script type="text/javascript" src="DesignApp.js"></script>
    <script type="text/javascript" src="IntakeData.js"></script>

    <script type="text/javascript">
    
        var conf = {
            color: {
                protein: "#d84315",
                carbohydrate: "#283593",
                fat: "#fdd835",
                fiber: "#0097a7",
                vitamin_A: "#4fc3f7",
                vitamin_B6: "#1565c0",
                vitamin_B12: "#7f9eb2",
                vitamin_C: "#008c9e",
                vitamin_D: "#343838",

                calcium: "#a8dba8",
                iron: "#79bd9a",
                zinc: "#3b8686",
                phosphorus: "#aed581",
                magnesium: "#8bc34a",
                potassium: "#689f38",
                sodium: "#388e3c",
                iodine: "#1b5e20",
            }
        }
        $(function() {
            var rniKey = {
                gender: "male",
                age: "teenager",
                key: "teenager_male"
            }

            var app = new App();
            var filterApp = new FilterApp();
            var explorerApp = new ExplorerApp();
            var designApp = new DesignApp();
            
            $(".btn-age").click(function() {
                var key = $(this).attr("id");
                rniKey.age = key.replace("btn-", "");
                rniKey.key = rniKey.age+"_"+rniKey.gender

                $(".btn-age").removeClass("active");
                $(this).addClass("active");
                PubSub.publish('change-rni', rniKey)
            });

            $(".btn-sex").click(function() {
                var key = $(this).attr("id");
                rniKey.gender = key.replace("btn-", "");
                rniKey.key = rniKey.age+"_"+rniKey.gender

                $(".btn-sex").removeClass("active");
                $(this).addClass("active");
                PubSub.publish('change-rni', rniKey)
            });

            d3.selection.prototype.moveToFront = function () {
                return this.each(function () {
                    this.parentNode.appendChild(this);
                });
            };

            d3.selection.prototype.moveToBack = function () {
                return this.each(function () {
                    var firstChild = this.parentNode.firstChild;
                    if (firstChild) {
                        this.parentNode.insertBefore(this, firstChild);
                    }
                });
            };
            
            var _filter = {}
            var _data = [];
            PubSub.subscribe('filter-data', function(msg, filterval) {
                var _filtered_data = _data;
                for(k in filterval) {
                    if (filterval[k] != null) {
                        _filter[k] = filterval[k];
                    } else {
                        _filter[k] = null;
                    }
                }

                console.log(_filter)

                var areafilters = ["protein", "carbohydrate", "fat", "fiber"];
                _.forEach(areafilters, (k) => {
                    // console.log(_filtered_data.length)
                    if (_filter[k] != null) {
                        var min = _.min([_filter[k].start, _filter[k].end])*1000
                        var max = _.max([_filter[k].start, _filter[k].end])*1000
                        _filtered_data = _filtered_data.filter((d) => {
                            return (d[k] >= min) && (d[k] <= max);
                        })
                        // console.log(_filtered_data.length)
                    }
                })
                
                var bubblefilters = ["allergic", "preference"];
                _.forEach(bubblefilters, (k) => {
                    var default_status = false;
                    if (k=="preference") {
                        default_status = true;
                    }

                    _.forEach(_filter[k], (ft) => {
                        if (ft.selected != default_status) {
                            _filtered_data = _filtered_data.filter((d) => {
                                return (d[ft.name]=="True") == false;
                            })
                        }
                    })    
                })

                var radarfilters = ["minerals", "vitamins"];
                _.forEach(radarfilters, (k) => {
                    _.forEach(_filter[k], (ft) => {
                        _filtered_data = _filtered_data.filter((d) => {
                            return d[ft.key] < ft.value;
                        })
                    })    
                })

                if (_filter["name"]) {
                    _filtered_data = _filtered_data.filter((d) => {
                        return _.includes(d.name.toLowerCase(), _filter["name"].toLowerCase())
                    })
                }

                $("#no-filtered").html(_filtered_data.length)
                PubSub.publish('filtered-data-ready', _filtered_data);
                
            });

            d3.csv('small_sample.csv').then(function (data) {    
                $("#no-filtered").html(data.length)
                $("#no-all").html(data.length)

                _data = app.preprocessing(data);            
                filterApp.visualize(_data, {rni: rniKey});
                explorerApp.init(_data, {rni: rniKey});
                explorerApp.visualize();
                designApp.visualize(_data, {rni: rniKey});
            });
        })
    </script>
</body>

</html>